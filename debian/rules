#!/usr/bin/make -f

ifneq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
	DEB_CXXFLAGS += -O0
else
	DEB_CXXFLAGS += -O2
endif

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	MAKEFLAGS += -j$(NUMJOBS)
endif

include /usr/share/quilt/quilt.make

DEB=debian/html2text

build: build-stamp
build-stamp: debian/stamp-patched
	dh_testdir
	./configure --prefix=$(DEB)/usr
	sed -i 's/$$(CXXFLAGS)/$$(CXXFLAGS) $$(DEB_CXXFLAGS)/g' Makefile
	$(MAKE) DEB_CXXFLAGS=$(DEB_CXXFLAGS) LOCAL_LDFLAGS=-g 
	touch build-stamp

clean: unpatch
	dh_testdir
	dh_testroot
	rm -f build-stamp
	-rm -rf Makefile html2text *.o configure-tmp Dependencies
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

binary-indep:

binary-arch: build install
	dh_testdir
	dh_testroot
	dh_install html2text usr/bin
	dh_installdocs README TODO ascii.substitutes
	dh_installexamples pretty.style
	dh_installmime
	zcat html2text.1.gz | sed \
		's,(HTTP 301/ 307),(HTTP 301/ 307).\nProxy servers are not supported,' \
		| gzip -c9 > $(DEB)/usr/share/man/man1/html2text.1.gz
	# darn, patch those typos (bug #309887 here)
	zcat html2textrc.5.gz | sed \
		"s/specifiy/specify/; s/elemet/element/; s/who's/whose/" \
		| gzip -c9 > $(DEB)/usr/share/man/man5/html2textrc.5.gz
	dh_installchangelogs CHANGES
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary:	binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary
